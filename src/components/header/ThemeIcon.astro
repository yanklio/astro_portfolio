---
import { Icon } from "astro-icon/components";
---

<button
    id="themeToggle"
    class="theme-toggle paper-button"
    aria-label="Toggle theme"
>
    <Icon class="icon sun" name="ic:baseline-wb-sunny" />
    <Icon class="icon moon" name="ic:baseline-dark-mode" />
</button>

<style>
    .theme-toggle {
        height: 50px;
        padding: 0 16px;
        background: var(--bg1);
        font-size: 1.2rem;

        cursor: pointer;
    }

    .moon {
        display: none;
    }

    :global(.dark) .sun {
        display: none;
    }
    :global(html.dark) .moon {
        display: block;
    }
</style>

<script is:inline>
    function initTheme() {
        const theme = (() => {
            const localStorageTheme = localStorage?.getItem("theme") ?? "";
            if (["dark", "light"].includes(localStorageTheme)) {
                return localStorageTheme;
            }
            if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                return "dark";
            }
            return "light";
        })();

        if (theme === "light") {
            document.documentElement.classList.remove("dark");
        } else {
            document.documentElement.classList.add("dark");
        }

        window.localStorage.setItem("theme", theme);
    }

    function handleToggleClick() {
        const element = document.documentElement;
        element.classList.toggle("dark");

        const isDark = element.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function setupThemeToggle() {
        const themeToggle = document.getElementById("themeToggle");
        if (themeToggle) {
            themeToggle.removeEventListener("click", handleToggleClick);
            themeToggle.addEventListener("click", handleToggleClick);
        }
    }

    initTheme();
    setupThemeToggle();

    document.addEventListener("astro:after-swap", () => {
        initTheme();
        setupThemeToggle();
    });
</script>

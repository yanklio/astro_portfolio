 ---
const currentPath = Astro.url.pathname;
import Logo from "../Logo.astro";
import Navigation from "./Navigation.astro";
import RSSButton from "./RSSButton.astro";
import ThemeIcon from "./ThemeIcon.astro";
import { Icon } from "astro-icon/components";
---

<header>
    <nav>
        <Logo />
        <div class="desktop-only">
            <Navigation />
        </div>

        <div class="desktop-only">
            <div class="single-row">
                <RSSButton />
                <ThemeIcon />
            </div>
        </div>

        <div class="mobile-only">
            <button
                id="mobileMenuToggle"
                class="mobile-menu-btn paper-button"
                aria-label="Toggle menu"
            >
                <Icon name="ic:menu" />
            </button>
        </div>
    </nav>

    <div id="mobileMenu" class="mobile-menu paper-border">
        <div class="menu-item">
            <a href="/" class:list={["menu-link", { active: currentPath === "/" }]}>
                <div class="menu-content">
                    <div class="menu-title">/home</div>
                    <div class="menu-desc">Navigate to home page</div>
                </div>
                <Icon name="ic:baseline-home" />
            </a>
        </div>
        <div class="menu-item">
            <a href="/blog" class:list={["menu-link", { active: currentPath === "/blog" || currentPath.startsWith("/blog/") }]}>
                <div class="menu-content">
                    <div class="menu-title">/blog</div>
                    <div class="menu-desc">Read blog posts</div>
                </div>
                <Icon name="ic:baseline-article" />
            </a>
        </div>
        <div class="menu-divider"></div>
        <div class="menu-item">
            <button id="copyRSS" class="menu-link">
                <div class="menu-content">
                    <div class="menu-title">RSS Feed</div>
                    <div class="menu-desc">Copy feed URL to clipboard</div>
                </div>
                <Icon name="ic:outline-rss-feed" />
            </button>
        </div>
        <div class="menu-item">
            <button id="mobileThemeToggle" class="menu-link">
                <div class="menu-content">
                    <div class="menu-title">Theme</div>
                    <div class="menu-desc">Switch between light and dark mode</div>
                </div>
                <div class="theme-icons">
                    <Icon class="icon sun" name="ic:baseline-wb-sunny" />
                    <Icon class="icon moon" name="ic:baseline-dark-mode" />
                </div>
            </button>
        </div>
    </div>
</header>

<style>
    nav {
        min-height: 82px;

        background-color: var(--bg_soft);
        position: sticky;
        top: 0;
        border-bottom: 4px solid var(--fg2);
        width: 100%;
        z-index: 10;

        padding: 2px 16px;

        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .single-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .mobile-menu-btn {
        height: 50px;
        padding: 0 16px;
        font-size: 1.5rem;
        background: var(--bg1);

        display: flex;
        justify-content: center;
        align-items: center;
    }

    .mobile-menu {
        position: fixed;
        top: 82px;
        right: 16px;
        width: 300px;
        max-width: calc(100vw - 32px);
        background-color: var(--bg);
        display: none;
        flex-direction: column;
        z-index: 9;
        box-shadow: var(--paper-shadow);
    }

    .mobile-menu.open {
        display: flex;
    }

    .menu-item {
        border-bottom: 2px solid var(--fg2);
    }

    .menu-item:last-child {
        border-bottom: none;
    }

    .menu-link {
        width: 100%;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg);
        color: var(--fg1);
        text-decoration: none;
        font-size: 1rem;
        transition: background-color 0.2s ease;
        cursor: pointer;
        border: none;
    }

    .menu-link:hover {
        background-color: var(--bg2);
    }

    .menu-link.active {
        background-color: var(--yellow-dim);
        color: var(--black);
        font-weight: 600;
    }

    .menu-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }

    .menu-title {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .menu-desc {
        font-size: 0.85rem;
        color: var(--fg2);
    }

    .menu-divider {
        height: 2px;
        background-color: var(--fg2);
    }

    .theme-icons {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .theme-icons .moon {
        display: none;
    }

    :global(.dark) .theme-icons .sun {
        display: none;
    }

    :global(html.dark) .theme-icons .moon {
        display: block;
    }

    @media (min-width: 768px) {
        .mobile-menu {
            display: none !important;
        }
    }
</style>

<script>
    function setupMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const mobileMenuToggle = document.getElementById("mobileMenuToggle");
        const copyRSS = document.getElementById("copyRSS");
        const mobileThemeToggle = document.getElementById("mobileThemeToggle");

        mobileMenuToggle?.addEventListener("click", () => {
            mobileMenu?.classList.toggle("open");
        });

        copyRSS?.addEventListener("click", () => {
            navigator.clipboard.writeText(window.location.origin + "/rss.xml");
            mobileMenu?.classList.remove("open");
        });

        mobileThemeToggle?.addEventListener("click", () => {
            const element = document.documentElement;
            element.classList.toggle("dark");
            const isDark = element.classList.contains("dark");
            localStorage.setItem("theme", isDark ? "dark" : "light");
        });
    }

    document.addEventListener("click", (e) => {
        const mobileMenu = document.getElementById("mobileMenu");
        const mobileMenuToggle = document.getElementById("mobileMenuToggle");
        if (mobileMenuToggle && mobileMenu) {
            const target = e.target as Node;
            if (
                !mobileMenu.contains(target) &&
                !mobileMenuToggle.contains(target)
            ) {
                mobileMenu.classList.remove("open");
            }
        }
    });

    setupMobileMenu();
    document.addEventListener("astro:after-swap", setupMobileMenu);
</script>
